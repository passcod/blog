<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from blog.nut/2014/mar/15/lz4-compression-for-ramdisk by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 15 Oct 2020 15:05:49 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <script>var _gaq = _gaq || []; _gaq.push(['_setDomainName', location.hostname]);</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1">
    <title>
LZ4 compression for ramdisk -       Félix “passcod” Saparelli - Blog
    </title>
    <link rel="alternate" href="../../../feed.xml">
    <link rel="stylesheet" href="../../../assets/1.3.3/style.css">
  </head>

  <body>
    <div class="raised">
      <header class="root">
        <h1><a href="../../../index.html">Félix Saparelli</a></h1>
        <p class="sidelong"><a rel="me" href="https://passcod.name/">(about me)</a></p>
        <p class="subtitle">a.k.a. passcod<a href="https://blog.passcod.name/trademark">™</a></p>
      </header>
      <main>
        <article class="h-entry e-content">
  <header>
    <h1 class="p-name">LZ4 compression for ramdisk</h1>

  
    <p>Posted on <a href="lz4-compression-for-ramdisk.html" class="u-url"><date datetime="2014-03-15T00:00:00.000Z" title="2014-03-15T00:00:00.000Z" class="dt-published">Mar 15 ‘14</date></a></p>
  

  
    <p>This
      
      <a href="../../../tag/entry.html" rel="main tag" class="p-category">entry</a>
      is also tagged as
        <a href="../../../tag/linux.html" rel="tag" class="p-category">linux</a>, <a href="../../../tag/kernel.html" rel="tag" class="p-category">kernel</a>, <a href="../../../tag/software.html" rel="tag" class="p-category">software</a>
      
    </p>
  

  
  </header>

  <p>A little while ago I saw that <a href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">lz4</a> became a new optional dependency to <a href="https://wiki.archlinux.org/index.php/mkinitcpio">mkinitcpio</a>. Today I decided to see why.</p>
<p>My mkinitcpio setup is a bit more complex than the Arch default. Instead of a single <strong>/etc/mkinitcpio.conf</strong>, I have the following structure:</p>
<pre><code class="language-tree">/etc/mkinitcpio
├── all.conf
├── default.conf
├── fallback.conf
└── nozip.conf
/etc/mkinitcpio.d
└── linux.preset
</code></pre>
<p>I have three ramdisks: <strong>default</strong>, which is the smallest I can get it, <strong>nozip</strong>, which is <strong>default</strong> but with <code>cat</code> (no) compression, and <strong>fallback</strong>, which contains rescue and backup hooks. Notably, <strong>default</strong> uses the <code>systemd</code> hook to do away with <code>base</code>, <code>udev</code>, etc.</p>
<p>My configs are hierarchical. I realised that the config files are actually bash, so one can use <code>source /etc/mkinitcpio/&lt;file&gt;</code> to source “parent” entries. This means that <strong>all.conf</strong> contains everything that’s not variable between configs: core <code>$HOOKS</code>, filesystems loaded explicitely in <code>$MODULES</code>, empty definitions for everything else. Then the rest builds up onto that. It’s pretty neat.</p>
<p>Anyway, enough exposition. Originally I used <strong>cat</strong> for both default and fallback, but then I realised a compressed image actually booted faster. So after quick informal testing, I went with gzip. I left the fallback image uncompressed because a) I don’t care about speed when booting in fallback mode, and b) it’s easier to open up and stitch back if I need to modify something manually. b) also led me to create a nozip image for default, just in case.</p>
<p>My <code>/boot/</code> looked like this:</p>
<pre><code class="language-plain">49M  initramfs-linux-fallback.img
13M  initramfs-linux-nozip.img
4.9M initramfs-linux.img
</code></pre>
<p>When I initially tried <code>lz4</code>, the size jumped up to <code>7.0M</code>. No great. I adjusted the options to get maximum compression, believing that would take too much CPU, and so I would have to compromised.</p>
<p>To my surprise, <code>lz4 -9</code> didn’t compress as well as gzip:</p>
<pre><code class="language-plain">49M  initramfs-linux-fallback.img
13M  initramfs-linux-nozip.img
5.7M initramfs-linux.img
</code></pre>
<p>But it <em>seemed faster</em>. And that would be a big win: 800K vs. faster (de)compression? No contest. Instead of testing the total mkinitcpio time for each, I went with directly testing compression and decompression on the <strong>nozip</strong> image.</p>
<h2>gzip</h2>
<pre><code class="language-bash">$ time gzip initramfs-linux-nozip.img
gzip initramfs-linux-nozip.img  0.78s user 0.01s system 99% cpu 0.793 total

$ time gunzip initramfs-linux-nozip.img.gz
gunzip initramfs-linux-nozip.img.gz  0.12s user 0.01s system 71% cpu 0.182 total
</code></pre>
<h2>LZ4</h2>
<pre><code class="language-bash">$ time lz4 -9 initramfs-linux-nozip.img
Compressed filename will be : initramfs-linux-nozip.img.lz4
Compressed 13149696 bytes into 5941253 bytes ==&gt; 45.18%
lz4 -9 initramfs-linux-nozip.img  0.53s user 0.01s system 99% cpu 0.541 total

$ time lz4 initramfs-linux-nozip.img.lz4
Decoding file initramfs-linux-nozip.img
Successfully decoded 13149696 bytes
lz4 initramfs-linux-nozip.img.lz4  0.02s user 0.01s system 88% cpu 0.026 total
</code></pre>
<p>Ladies, gentlemen, and otherwise-gendered, I present thee <code>lz4</code>. At full compression, slightly faster. And for decompression, an order of magnitude faster. This is impressive.</p>
<p>Hear hear!</p>
<p><strong>Update</strong>: <a href="https://twitter.com/Cyan4973">Yann Collet</a> has kindly <a href="https://twitter.com/Cyan4973/status/444791758376169472">informed me</a> of a «“hidden” option -A, which compresses a tiny bit more than -9… for “compress once, decompress plenty” scenarios», which fits the bill perfectly. Thanks Yann! I’ll definitely use this.</p>


  <footer>
  
    <p>Travel back to the <a rel="prev" href="../../feb/19/github-cleanup.html" title="Today I cleaned up my Github repositories. That means I looked through all the repos I own, updated some of them, and deleted a whole lot. Over forty in fact! Here’s a quick summary: Names: source…">previous</a> article</p>
  

  
    <p>Skip forward to the <a rel="next" href="../19/sleep.html" title="Darkness Darkness all around and / light but not light; red / orange dark but less dark / than darkness. Lines of darkness dancing / across. Deformed shapes of / fire running in circles. Black dark black…">next</a> one</p>
  

    <p>Praise, thoughts, criticism? <a href="https://twitter.com/passcod">@passcod</a> or <a href="mailto:felix@passcod.name">felix@passcod.name</a></p>

  
  </footer>
</article>

      </main>
    </div>
    <footer class="root">
      <p>
        <a rel="alternate" href="../../../feed.xml">Feed</a>.
        © 2008–2020.
        Content licensed under <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.
      </p>
    </footer>

    <button class="flip" title="Turn the lights off.">day</button>
    <script async src="../../../assets/1.3.3/circadian.js"></script>
    <script async src="../../../assets/1.3.3/prism.js"></script>

    <link rel="stylesheet" href="../../../assets/1.3.3/fonts.css">
    <link rel="stylesheet" href="../../../assets/1.3.3/prism.css">
  </body>

<!-- Mirrored from blog.nut/2014/mar/15/lz4-compression-for-ramdisk by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 15 Oct 2020 15:05:49 GMT -->
</html>
