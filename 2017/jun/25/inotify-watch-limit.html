<!DOCTYPE html>
<html lang="en">
  
<!-- Mirrored from blog.nut/2017/jun/25/inotify-watch-limit by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 15 Oct 2020 14:47:07 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <script>var _gaq = _gaq || []; _gaq.push(['_setDomainName', location.hostname]);</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1">
    <title>
INotify watch limit -       Félix “passcod” Saparelli - Blog
    </title>
    <link rel="alternate" href="../../../feed">
    <link rel="stylesheet" href="../../../assets/1.3.3/style.css">
  </head>

  <body>
    <div class="raised">
      <header class="root">
        <h1><a href="../../../index-2.html">Félix Saparelli</a></h1>
        <p class="sidelong"><a rel="me" href="https://passcod.name/">(about me)</a></p>
        <p class="subtitle">a.k.a. passcod<a href="https://blog.passcod.name/trademark">™</a></p>
      </header>
      <main>
        <article class="h-entry e-content">
  <header>
    <h1 class="p-name">INotify watch limit</h1>

  
    <p>Posted on <a href="inotify-watch-limit.html" class="u-url"><date datetime="2017-06-25T23:57:05.000Z" title="2017-06-25T23:57:05.000Z" class="dt-published">Jun 25 ‘17</date></a></p>
  

  
    <p>This
      
      <a href="../../../tag/documentation.html" rel="main tag" class="p-category">documentation</a>
      is also tagged as
        <a href="../../../tag/notify.html" rel="tag" class="p-category">notify</a>, <a href="../../../tag/linux.html" rel="tag" class="p-category">linux</a>
      
    </p>
  

  
  </header>

  <p>On Linux, INotify might sometimes hit its internal watch limit. In applications
like <a href="https://www.dropbox.com/">dropbox</a>, <a href="https://github.com/guard/guard">guard</a>, <a href="https://linux.die.net/man/1/tail">tail</a>, my own <a href="https://github.com/passcod/notify">notify</a>, and tools depending on it:
<a href="https://github.com/mattgreen/watchexec">watchexec</a>, <a href="https://github.com/passcod/cargo-watch">cargo watch</a>, <a href="https://github.com/jwilm/alacritty">alacritty</a>… this error may manifest like this:</p>
<ul>
<li>
<p>Unable to monitor filesystem Please run:
<code>echo 100000 | sudo tee /proc/sys/fs/inotify/max_user_watches</code>
and restart Dropbox to correct the problem.</p>
</li>
<li>
<p>No space left on device - Failed to watch “…”: The user limit on the total
number of inotify watches was reached or the kernel failed to allocate a
needed resource. (Errno::ENOSPC)</p>
</li>
<li>
<p>unable to create watcher:
<code>Io(Error { repr: Os { code: 28, message: “No space left on device” } })</code></p>
</li>
<li>
<p>tail: cannot watch ‘/path/to/dir’: No space left on device</p>
</li>
<li>
<p>Failed to watch /path/to/dir; upper limit on inotify watches reached!</p>
</li>
</ul>
<h2>What the manual says</h2>
<p>As per <a href="https://linux.die.net/man/7/inotify">inotify(7)</a>:</p>
<blockquote>
<p>The following interfaces can be used to limit the amount of kernel memory
consumed by inotify:</p>
<pre><code>/proc/sys/fs/inotify/max_queued_events
</code></pre>
<p>The value in this file is used when an application calls <code>inotify_init(2)</code> to
set an upper limit on the number of events that can be queued to the
corresponding inotify instance. Events in excess of this limit are dropped,
but an <code>IN_Q_OVERFLOW</code> event is always generated.</p>
<pre><code>/proc/sys/fs/inotify/max_user_instances
</code></pre>
<p>This specifies an upper limit on the number of inotify instances that can be
created per real user ID.</p>
<pre><code>/proc/sys/fs/inotify/max_user_watches
</code></pre>
<p>This specifies an upper limit on the number of watches that can be created
per real user ID.</p>
</blockquote>
<h2>Why this occurs</h2>
<p>INotify watches have to be specified for each directory; there is no way to
specify that a directory <em>and all its subdirectories</em> should be monitored using
a single call or watch. Thus, libraries and applications implement their own
recursive descent into directories and simply add watches to each folder they
find. Some do that more efficiently than others.</p>
<p>Another issue is that the limit for those watches is specified <em>per user</em>, not
<em>per application</em>, so the “pool” of available watches may be consumed by
different applications at the same time, leading to an application that may
consume a completely reasonable amount of watches failing because the <em>rest</em> of
the pool was exhausted by something else running as the same user.</p>
<p>The default limit on most Linux distributions is <strong>8192</strong>.</p>
<p>This is regularly blown up by watching dependency folders, like <code>node_modules</code>
or <code>vendor</code>, or more extreme, by watching your entire <code>$HOME</code> folder.</p>
<h2>Fix considerations</h2>
<p>For most users, the default limit is much too low. <strong>65536</strong> is a good start on
a more reasonable limit. Increasing to further than that is governed by more
low-level details and your own concerns:</p>
<p>An INotify watch costs 540 bytes of kernel memory on 32-bit architectures, and
1080 bytes on 64-bit architectures. Kernel memory is <em>unswappable</em>. In addition
to that, the library or application will use more memory to store the handle and
other information (this time in <em>swappable</em> memory). <a href="https://github.com/passcod/notify">Notify</a> uses about
10 bytes plus the full path of the watched entry.</p>
<p>There are recorded instances of people using <em>millions</em> of watches. It just
means they are okay with potentially spending gigabytes of kernel and userspace
memory on that.</p>
<h2>Adjusting the limit</h2>
<p>You can either write directly to /proc or use <code>sysctl</code> (recommended):</p>
<ul>
<li>
<p><code>echo 65536 | sudo tee /proc/sys/fs/inotify/max_user_watches</code></p>
</li>
<li>
<p><code>sudo sysctl fs.inotify.max_user_watches=65536</code></p>
</li>
</ul>
<p>To do it permanently, you should put <code>fs.inotify.max_user_watches=65536</code> in the
sysctl configuration, which is either a new file (descriptively named) in
<code>/etc/sysctl.d/</code> (recommended) or a line in <code>/etc/sysctl.conf</code>.</p>
<h2>Sources</h2>
<p>Information was mostly taken from kernel manpages and sources, but this article
was preceded by various blog posts and StackExchange QAs:</p>
<ul>
<li>http://web.archive.org/web/20161106193425/http://blog.sorah.jp/2012/01/24/inotify-limitation</li>
<li>https://unix.stackexchange.com/questions/13751/kernel-inotify-watch-limit-reached</li>
<li>http://www.linuxjournal.com/article/8478</li>
<li>https://docs.rs/inotify/0.3.0/inotify/wrapper/type.Watch.html</li>
<li>https://stackoverflow.com/questions/535768/what-is-a-reasonable-amount-of-inotify-watches-with-linux</li>
<li>https://github.com/guard/listen/wiki/Increasing-the-amount-of-inotify-watchers</li>
</ul>
<h3>Note on dnotify, inotify, fanotify, fsnotify</h3>
<p>Dnotify was the original Linux kernel implementation of filesystem watching.
Prior to dnotify was “FAM”, which came from IRIX. Dnotify was replaced around
2008 by inotify. Then fanotify was initially implemented, but ultimately not
merged and abandoned. Meanwhile, fsnotify replaced the entire <em>backend</em> kernel
implementation, with dnotify and inotify (and then fanotify) re-written as
<em>frontends</em> on fsnotify, eliminating duplication.</p>
<p>Thus, nowadays (i.e. on modern kernels) when speaking of all or any of these
systems, one is talking about the <em>same</em> mechanism, but accessed through
different kernel calls.</p>


  <footer>
  
    <p>Travel back to the <a rel="prev" href="../10/monthly-update.html" title="In the pale darkness of dawn Did a slight rework of the story to have it stand as two distinct fics, especially following my reading of Vanity…">previous</a> article</p>
  

  
    <p>Skip forward to the <a rel="next" href="../../jul/10/monthly-update.html" title="List I watched Neil Gaiman speaking to students last week, and it reminded me that I did have specific things I’ve wanted to do forever. Unlike Gaiman, though, I’ve never noted…">next</a> one</p>
  

    <p>Praise, thoughts, criticism? <a href="https://twitter.com/passcod">@passcod</a> or <a href="mailto:felix@passcod.name">felix@passcod.name</a></p>

  
  </footer>
</article>

      </main>
    </div>
    <footer class="root">
      <p>
        <a rel="alternate" href="../../../feed">Feed</a>.
        © 2008–2020.
        Content licensed under <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a>.
      </p>
    </footer>

    <button class="flip" title="Turn the lights off.">day</button>
    <script async src="../../../assets/1.3.3/circadian.js"></script>
    <script async src="../../../assets/1.3.3/prism.js"></script>

    <link rel="stylesheet" href="../../../assets/1.3.3/fonts.css">
    <link rel="stylesheet" href="../../../assets/1.3.3/prism.css">
  </body>

<!-- Mirrored from blog.nut/2017/jun/25/inotify-watch-limit by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 15 Oct 2020 14:47:07 GMT -->
</html>
